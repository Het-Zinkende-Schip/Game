<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Tabletop Boats</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet"/>
  <style>
    html,body,#map {
      height:100%;
      margin:0;
      background:#2e1f02;
      overflow:hidden;
    }

    .map-area {
      position:relative;
      width:90%;          /* 5% left/right */
      height:95%;         /* 5% top */
      margin:5%;
      top: 5%;
    }

    .map-clip {
      position:absolute;
      inset:0;
      overflow:hidden;    /* crops pitched map edges */
    }

    #map {
      width:100%;
      height:88%;
      position:relative;
      z-index:1;
    }

    .map-border {
      position:absolute;
      z-index:2;                /* above map */
      top: 5%;
      width:100%;
      height:100%;
      pointer-events:none;
      transform: perspective(1000px) rotateX(20deg);   /* same pitch as map */
      transform-origin:center center;
    }

    .map-border-image {
      width:100%;
      height:100%;
      pointer-events:none;
    }

    .map-border-instrument-container {
      position:absolute;
    }

    /* Keep pixel-art crisp when scaled */
    canvas, .maplibregl-canvas { image-rendering: pixelated; }

    /* https://www.w3schools.com/howto/tryit.asp?filename=tryhow_css_modal2 */

    /* The Modal (background) */
    .modal {
      display: none; /* Hidden by default */
      position: fixed; /* Stay in place */
      z-index: 4; /* Sit on top */
      padding-top: 100px; /* Location of the box */
      left: 0;
      top: 0;
      width: 100%; /* Full width */
      height: 100%; /* Full height */
      overflow: auto; /* Enable scroll if needed */
      background-color: rgb(0,0,0); /* Fallback color */
      background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    }

    /* Modal Content */
    .modal-content {
      position: relative;
      background-image: url("images/vintage-paper-texture-1504806601t0F-dialog.png");
      margin: auto;
      padding: 0;
      border: 1px solid #888;
      width: 80%;
      box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
      -webkit-animation-name: animatetop;
      -webkit-animation-duration: 0.4s;
      animation-name: animatetop;
      animation-duration: 0.4s
    }

    /* Add Animation */
    @-webkit-keyframes animatetop {
      from {top:-300px; opacity:0} 
      to {top:0; opacity:1}
    }

    @keyframes animatetop {
      from {top:-300px; opacity:0}
      to {top:0; opacity:1}
    }

    /* The Close Button */
    .close {
      color: white;
      float: right;
      font-size: 28px;
      font-weight: bold;
      margin: .5em;
    }

    .close:hover,
    .close:focus {
      color: #000;
      text-decoration: none;
      cursor: pointer;
    }

    .modal-header {
      padding: 2px 16px;
      background-color: #0000004d;
      color: white;
    }

    .modal-body {
      background-color: #ffffffb1;
      padding: 2px 16px;
    }

    .modal-footer {
      padding: 2px 16px;
      background-color: #0000004d;
      color: white;
    }

    .choicesContainer {
      margin: 10px;
      background-color: #ffffffb1;
      display: flex;
      justify-content: center;  /* centers horizontally */
      align-items: center;      /* centers vertically if taller */
      text-align: center;
      gap: 1em;
      flex-wrap: wrap;
    }

    .choice {
      color: rgb(250, 171, 171);
      background-color: #000000b1;
      border: #000 7px solid;
      padding: 1em;
      margin: 0;
    }

    .choice:hover {
      border: #eb5555 7px solid;
      padding: 1em;
      margin: 0;
    }

    .place-marker {
      transition: filter 0.2s ease;
    }

    .place-marker:hover {
      filter: drop-shadow(0 0 8px #00ffff);
    }

    .holder {
      margin: 12rem auto 0;
      width: 150px;
      height: 400px;
      position: relative;
    }

    .holder *, .holder *:before, .holder *:after {
      position: absolute;
      content: "";
    }

    .candle {
      bottom: 0;
      width: 150px;
      height: 300px;
      border-radius: 150px / 40px;
      -webkit-box-shadow: inset 20px -30px 50px 0 rgba(0, 0, 0, 0.4), inset -20px 0 50px 0 rgba(0, 0, 0, 0.4);
      box-shadow: inset 20px -30px 50px 0 rgba(0, 0, 0, 0.4), inset -20px 0 50px 0 rgba(0, 0, 0, 0.4);
      background: #190f02;
      background: -webkit-gradient(linear, left top, left bottom, from(#e48825), color-stop(#e78e0e), color-stop(#833c03), color-stop(50%, #4c1a03), to(#1c0900));
      background: linear-gradient(#e48825, #e78e0e, #833c03, #4c1a03 50%, #1c0900);
    }

    .candle:before {
      width: 100%;
      height: 40px;
      border-radius: 50%;
      border: 2px solid #d47401;
      background: #b86409;
      background: radial-gradient(#ffef80, #b86409 60%);
      background: radial-gradient(#eaa121, #8e4901 45%, #b86409 80%);
    }

    .candle:after {
      width: 34px;
      height: 10px;
      left: 50%;
      -webkit-transform: translateX(-50%);
      -ms-transform: translateX(-50%);
      transform: translateX(-50%);
      border-radius: 50%;
      top: 14px;
      -webkit-box-shadow: 0 0 20px 0 rgba(0, 0, 0, 0.5);
      box-shadow: 0 0 20px 0 rgba(0, 0, 0, 0.5);
      background: radial-gradient(rgba(0, 0, 0, 0.6), transparent 45%);
    }

    .thread {
      width: 6px;
      height: 36px;
      top: -17px;
      left: 50%;
      z-index: 1;
      border-radius: 40% 40% 0 0;
      -webkit-transform: translateX(-50%);
      -ms-transform: translateX(-50%);
      transform: translateX(-50%);
      background: #121212;
      background: -webkit-gradient(linear, left top, left bottom, from(#d6994a), color-stop(#4b232c), color-stop(#121212), color-stop(black), color-stop(90%, #e8bb31));
      background: linear-gradient(#d6994a, #4b232c, #121212, black, #e8bb31 90%);
    }

    .flame {
      width: 24px;
      height: 120px;
      left: 50%;
      -webkit-transform-origin: 50% 100%;
      -ms-transform-origin: 50% 100%;
      transform-origin: 50% 100%;
      -webkit-transform: translateX(-50%);
      -ms-transform: translateX(-50%);
      transform: translateX(-50%);
      bottom: 100%;
      border-radius: 50% 50% 20% 20%;
      background: rgba(255, 255, 255, 1);
      background: -webkit-gradient(linear, left top, left bottom, color-stop(80%, white), to(transparent));
      background: linear-gradient(white 80%, transparent);
      -webkit-animation: moveFlame 6s linear infinite, enlargeFlame 5s linear infinite;
      animation: moveFlame 6s linear infinite, enlargeFlame 5s linear infinite;
    }

    .flame:before {
      width: 100%;
      height: 100%;
      border-radius: 50% 50% 20% 20%;
      -webkit-box-shadow: 0 0 15px 0 rgba(247, 93, 0, .4), 0 -6px 4px 0 rgba(247, 128, 0, .7);
      box-shadow: 0 0 15px 0 rgba(247, 93, 0, .4), 0 -6px 4px 0 rgba(247, 128, 0, .7);
    }

    @-webkit-keyframes moveFlame {
      0%, 100% {
        -webkit-transform: translateX(-50%) rotate(-2deg);
        transform: translateX(-50%) rotate(-2deg);
      }

      50% {
        -webkit-transform: translateX(-50%) rotate(2deg);
        transform: translateX(-50%) rotate(2deg);
      }
    }

    @keyframes moveFlame {
      0%, 100% {
        -webkit-transform: translateX(-50%) rotate(-2deg);
        transform: translateX(-50%) rotate(-2deg);
      }

      50% {
        -webkit-transform: translateX(-50%) rotate(2deg);
        transform: translateX(-50%) rotate(2deg);
      }
    }

    @-webkit-keyframes enlargeFlame {
      0%, 100% {
        height: 120px;
      }

      50% {
        height: 140px;
      }
    }

    @keyframes enlargeFlame {
      0%, 100% {
        height: 120px;
      }

      50% {
        height: 140px;
      }
    }

    .glow {
      width: 26px;
      height: 60px;
      border-radius: 50% 50% 35% 35%;
      left: 50%;
      top: -48px;
      -webkit-transform: translateX(-50%);
      -ms-transform: translateX(-50%);
      transform: translateX(-50%);
      background: rgba(0, 133, 255, .7);
      -webkit-box-shadow: 0 -40px 30px 0 #dc8a0c, 0 40px 50px 0 #dc8a0c, inset 3px 0 2px 0 rgba(0, 133, 255, .6), inset -3px 0 2px 0 rgba(0, 133, 255, .6);
      box-shadow: 0 -40px 30px 0 #dc8a0c, 0 40px 50px 0 #dc8a0c, inset 3px 0 2px 0 rgba(0, 133, 255, .6), inset -3px 0 2px 0 rgba(0, 133, 255, .6);
    }

    .glow:before {
      width: 70%;
      height: 60%;
      left: 50%;
      -webkit-transform: translateX(-50%);
      -ms-transform: translateX(-50%);
      transform: translateX(-50%);
      bottom: 0;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.35);
    }

    .blinking-glow {
      width: 100px;
      height: 180px;
      left: 50%;
      top: -55%;
      -webkit-transform: translateX(-50%);
      -ms-transform: translateX(-50%);
      transform: translateX(-50%);
      border-radius: 50%;
      background: #ff6000;
      -webkit-filter: blur(50px);
      -moz-filter: blur(60px);
      -o-filter: blur(60px);
      -ms-filter: blur(60px);
      filter: blur(60px);
      -webkit-animation: blinkIt .1s infinite;
      animation: blinkIt .1s infinite;
    }

    @-webkit-keyframes blinkIt {
      50% {
        opacity: .8;
      }
    }

    @keyframes blinkIt {
      50% {
        opacity: .8;
      }
    }

    /* added to isolate candle */
    #candle-wrapper {
      position: absolute;
      z-index: 5;         /* below map if needed */
      right: 0;        /* move to right edge */
      bottom: 50px;       /* align bottom if desired */
      width: 200px;
      height: 400px;
      transform: scale(0.5); /* 50% of original size */
      transform-origin: bottom right; /* keeps alignment */
      isolation: isolate;   /* new stacking + CSS containment */
      contain: layout style; /* block style bleeding */
    }

    .candle-wrapper *::before,
    .candle-wrapper *::after {
      position: absolute;
      content: "";
    }

  </style>
</head>
<body>

<div id="candle-wrapper">
  <div class="holder">
    <div class="candle">
      <div class="blinking-glow"></div>
      <div class="thread"></div>
      <div class="glow"></div>
      <div class="flame"></div>
    </div>
  </div>
</div>

<div id="myModal" class="modal">

  <!-- Modal content -->
  <div class="modal-content">
    <div class="close">&times;</div>
    <div class="modal-header">
      <h2>Modal Header</h2>
    </div>
    <div class="modal-body">
      <p>Some text in the Modal Body</p>
      <p>Some other text...</p>
    </div>
    <div class="modal-footer">
      <h3>Modal Footer</h3>
    </div>
  </div>

</div>


<script>
let kaars_id="candle-wrapper";

const modal = document.getElementById("myModal");
const modalHeader = document.querySelector('#myModal .modal-header');
const modalBody = document.querySelector('#myModal .modal-body');
const modalFooter = document.querySelector('#myModal .modal-footer');
const closeModalX = document.getElementsByClassName("close")[0];

var modalCanClose = true;
var modalCallback = function() {}

setModalCanClose = function(canClose) {
  modalCanClose = canClose?true:false;
  if (modalCanClose) {
    closeModalX.style.visibility = "visible";
  } else {
    closeModalX.style.visibility = "hidden";
  }
}

setModalContent = function(header, body, footer) {
  modalHeader.innerHTML = `<h2>${header}</h2>`;
  modalBody.innerHTML = `<div>${body}</div>`;
  modalFooter.innerHTML = `<h3>${footer}</h3>`;
}

setModalContent(
  "Het zinkende schip... of wordt jij een cartograaf",
  "<img src='icons/ship.png' width=300></img>",
  ""
)

openModal = function() {
  modal.style.display = "block";
}

closeModal = function() {
  if (modalCanClose) modal.style.display = "none";
}


activateModal = function(title, text, choicesObject, mp3, userChoice = true, canClose = true, callback = function(value) {
  console.log('User chose:', value);
}) {
  modal.style.display = "none";

  const choicesHTML = choicesObject.map(choice => `
    <div class="choice" data-value="${choice.value}">
      ${choice.html}
    </div>
  `).join('');

  const bodyHTML = `
    <div class="modalText">${text}</div>
    <div class="choicesContainer">${choicesHTML}</div>
  `;

  setModalContent(
    title,
    bodyHTML,
    ""
  )

  modal.querySelectorAll('.choice').forEach(div => {
    div.addEventListener('click', () => {
      const value = div.getAttribute('data-value');
      callback(value);
      modal.style.display = "none";
    });
  });

  setModalCanClose(canClose)

  openModal()
}

window.addEventListener('keydown', e => {
  if (e.key === 'd') openModal()
  if (e.key === 'c') setModalCanClose(!modalCanClose)
  if (e.key === 'p') activateModal(
    title = "Kies je scheep",
    text = "Welke is de juiste soort?",
    choicesObject = [
      {
        'html': 'Een grote:<br/> <img src="icons/ship.png" width="300">',
        'value': 'DaShit1'
      },
      {
        'html': 'Een kleine:<br/> <img src="icons/ship.png" width="200">',
        'value': 'DaShit2'
      }
    ],
    mp3 = null,
    userChoice = true,
    canClose = false,
    callback = function(value) {
      console.log('User chose:', value);
    }
  )
  if (e.key === 'o') activateModal(
    title = "Kies je scheep",
    text = "Welke is de juiste soort?",
    choicesObject = [
      {
        'html': 'OK - lets go!',
        'value': 'DaShit1'
      }
    ],
    mp3 = null,
    userChoice = true,
    canClose = false,
    callback = function(value) {
      console.log('User chose:', value);
    }
  )
});

closeModalX.onclick = function() {
  closeModal()
}

// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
  if (event.target == modal) {
    closeModal()
  }
}
</script>


<div class="map-area">
  <div class="map-clip">
    <div id="map"></div>
  </div>
</div>

<div class="map-border">
  <div class="map-border-instrument-container">
    <img class="instrument" id="instrument1" src="icons/ship-icon.png" width="90"></img>
    <img class="instrument" id="instrument2" src="icons/ship-icon.png" width="90"></img>
    <img class="instrument" id="instrument3" src="icons/ship-icon.png" width="90"></img>
    <img class="instrument" id="instrument4" src="icons/ship-icon.png" width="90"></img>
  </div>
  <img src="images/vintage-paper-texture-1504806601t0F-background.png" class="map-border-image" alt="Scheep">
</div>

<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<script src="https://unpkg.com/@strudel/web@1.0.3"></script>

<script type="module">

/* async function readFile(filePath) {
  const response = await fetch(filePath);
  const fileContent = await response.text();
  return fileContent
}

const music1 = await readFile('muziek/route1.strudel');
const music2 = await readFile('muziek/route2.strudel'); */


initStrudel();

window.addEventListener('keydown', e => {
  if (e.key === '1') n("<0 -3 0 -3 0 -3>, 2 4 <[6,8] [7,9] [8,10]>").scale("<C:minor D:mixolydian C:minor E:mixolydian>/4").gain(.5).play();
  if (e.key === '2') n("<0 -3 0 -3 0 -3>, 2 4 <[6,8] [7,9]>").scale("<C:minor D:mixolydian C:minor E:mixolydian>/4").gain(.5).play();
  if (e.key === '3') hush()
});


</script>

<script type="module">
  // 1) Boot map


  async function loadGeoJSON(url) {
    const response = await fetch(url);
    if (!response.ok) throw new Error('Failed to load GeoJSON');
    return await response.json();
  }

  const geojson_routes = await loadGeoJSON('data/routes.geojson');

  function getRouteFeature(startUrl, endUrl) {
    const feature = geojson_routes.features.find(f =>
      f.properties.dplace === startUrl && f.properties.aplace === endUrl
    );
    return feature ? feature : null;
  }

  const map = new maplibregl.Map({
    container: 'map',
    style: {
      version: 8,

      sources: {
        ne_hr: {
          type: 'raster',
          tiles: [
            'https://www.goudatijdmachine.nl/geoserver/hetzinkendeschip/wms?' +
            'service=WMS&request=GetMap' +
            '&layers=hetzinkendeschip:NE2_HR_LC_SR_W_DR' +
            '&styles=&format=image/jpeg&transparent=false&version=1.1.1' +
            '&width=256&height=256' +
            '&srs=EPSG:3857&bbox={bbox-epsg-3857}'
          ],
          tileSize: 256,
          attribution: 'Natural Earth 2 High Resolution'
        },

        karta_ofver_nede: {
          type: 'raster',
          tiles: [
            'https://www.goudatijdmachine.nl/geoserver/hetzinkendeschip/wms?' +
            'service=WMS&request=GetMap' +
            '&layers=hetzinkendeschip:karta-ofver-nede-2d6ac673a7ff4048' +
            '&styles=&format=image/jpeg&transparent=false&version=1.1.1' +
            '&width=256&height=256' +
            '&srs=EPSG:3857&bbox={bbox-epsg-3857}'
          ],
          tileSize: 256,
          attribution: 'karta_ofver_nede'
        },

        carte_reduite: {
          type: 'raster',
          tiles: [
            'https://www.goudatijdmachine.nl/geoserver/hetzinkendeschip/wms?' +
            'service=WMS&request=GetMap' +
            '&layers=hetzinkendeschip:carte-reduite-de-f09fdf2128df419c' +
            '&styles=&format=image/jpeg&transparent=false&version=1.1.1' +
            '&width=256&height=256' +
            '&srs=EPSG:3857&bbox={bbox-epsg-3857}'
          ],
          tileSize: 256,
          attribution: 'Bellin, Jacques Nicolas, 1703–1772'
        },

        nova_totius_terr: {
          type: 'raster',
          tiles: [
            'https://www.goudatijdmachine.nl/geoserver/hetzinkendeschip/wms?' +
            'service=WMS&request=GetMap' +
            '&layers=hetzinkendeschip:nova-totius-terr-16f53c38a9ae485a' +
            '&styles=&format=image/jpeg&transparent=false&version=1.1.1' +
            '&width=256&height=256' +
            '&srs=EPSG:3857&bbox={bbox-epsg-3857}'
          ],
          tileSize: 256,
          attribution: 'nova_totius_terr'
        },

        osm: {
          type: 'raster',
          tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
          tileSize: 256,
          attribution: '© OpenStreetMap contributors'
        },

        opentopo: {
          type: 'raster',
          tiles: [
            'https://a.tile.opentopomap.org/{z}/{x}/{y}.png',
            'https://b.tile.opentopomap.org/{z}/{x}/{y}.png',
            'https://c.tile.opentopomap.org/{z}/{x}/{y}.png'
          ],
          tileSize: 256,
          attribution: 'Map data © OpenStreetMap contributors, SRTM | Style © OpenTopoMap (CC-BY-SA)'
        },

        carto_light: {
          type: 'raster',
          tiles: [
            'https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
            'https://b.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
            'https://c.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
            'https://d.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png'
          ],
          tileSize: 256,
          attribution: '© OpenStreetMap contributors, © CartoDB'
        }
      },


        layers: [
          //{ id: 'osm', type: 'raster', source: 'osm', layout: { visibility: 'visible' } },
          //{ id: 'opentopo', type: 'raster', source: 'opentopo', layout: { visibility: 'none' } },
          { id: 'ne_hr', type: 'raster', source: 'ne_hr', layout: { visibility: 'none' } },
          { id: 'karta_ofver_nede', type: 'raster', source: 'karta_ofver_nede', layout: { visibility: 'none' } },
          { id: 'nova_totius_terr', type: 'raster', source: 'nova_totius_terr', layout: { visibility: 'none' } },
          { id: 'carte_reduite', type: 'raster', source: 'carte_reduite', layout: { visibility: 'none' } },
          { id: 'carto_light', type: 'raster', source: 'carto_light', layout: { visibility: 'none' } }
        ]
    },
    center: [48.895, 1.372], // Amsterdam
    zoom: 2,
    pitch: 55,     // tabletop look
    bearing: 20,   // slight rotation
    antialias: true
  });

    let baseLayers = [];

    map.on('load', () => {
      // collect all raster layers present at load time
      baseLayers = map.getStyle().layers
        .filter(l => l.type === 'raster')
        .map(l => l.id);

      // ensure only the first is visible
      baseLayers.forEach((id, i) =>
        map.setLayoutProperty(id, 'visibility', i === 0 ? 'visible' : 'none')
      );

      console.log('Base layers detected:', baseLayers);
    });

    let currentBase = 0;

    function toggleBase() {
      if (baseLayers.length === 0) {
        console.log('No base layers!!!');
        return;
      }
      map.setLayoutProperty(baseLayers[currentBase], 'visibility', 'none');
      currentBase = (currentBase + 1) % baseLayers.length;
      map.setLayoutProperty(baseLayers[currentBase], 'visibility', 'visible');
      console.log('Base layer:', baseLayers[currentBase]);
    }

    document.addEventListener('keydown', e => {
      if (e.key.toLowerCase() === 't') toggleBase();
    });


  async function safeAddImage(name, src) {
    try {
      await addImage(name, src);
      console.log(`Loaded image: ${name}`);
    } catch (err) {
      console.error(`Failed to load image "${name}" from "${src}":`, err);
    }
  }

  // 3) After load, add sources and layers
  map.on('load', async () => {
    // Sprites: add your pixel PNGs. 64x64 works well.

    //await safeAddImage('boat', 'icons/ship.png'); // placeholder

    const el = document.createElement('img');
    el.src = 'icons/ship.png';
    el.style.width = '4em';


    const boatMarker = new maplibregl.Marker({element: el})
      .setLngLat([4.9, 52.37])
      .addTo(map);

    document.addEventListener('keydown', e => {
    if (e.key.toLowerCase() === 'a') {
      const route = getRouteFeature(
        'http://data.hetzinkendeschip.nl/id/place/65',
        'http://data.hetzinkendeschip.nl/id/place/9'
      );
      if (!route) {
        console.warn('Route not found');
        return;
      }
      animateAlong(route, boatMarker, {loop: false});
    }
  });

    map.addSource('data', {
      type: 'geojson',
      data: 'data/routes.geojson'
    });

    map.addLayer({
      id: 'lines',
      type: 'line',
      source: 'data',
      paint: {
        'line-color': '#ff0000',
        'line-width': 2
      }
    });


    // Start animation
    // animateAlong(route, { speedKts: 25, loop: true, centerCamera: true });
  });

  // Utilities
  function pointAt(lineFeature, t) {
    const line = turf.lineString(lineFeature.geometry.coordinates);
    const len = turf.length(line, { units: 'kilometers' });
    const pt = turf.along(line, t * len, { units: 'kilometers' });
    // compute heading from small step ahead
    const eps = 0.0005 * len;
    const ptA = pt;
    const ptB = turf.along(line, Math.min(t * len + eps, len), { units: 'kilometers' });
    const bearing = 20 //turf.bearing(ptA, ptB);
    return {
      type: 'Feature',
      properties: { heading: bearing },
      geometry: { type: 'Point', coordinates: pt.geometry.coordinates }
    };
  }

  async function addImage(name, src) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => { 
        map.addImage(name, img, { pixelRatio: 1 }); 
        //img.style.display = 'block';
        //document.body.appendChild(img);
        resolve(img); 
      };
      //img.id = name;
      img.onerror = reject;
      img.src = src;
    });
  }

  function hideAllInstruments() {
    for(n=1;n<5;n++) {
      document.getElementById(`instrument${n}`).style.visibility = "hidden"
    }
  }

  function showInstrument(n) {
    document.getElementById(`instrument${n}`).style.visibility = "visible"
  }

  const examplePlaceOptions = [
    {
      location: [0,0],
      value: "place1"
    },
        {
      location: [10,10],
      value: "place2"
    },
    {
      location: [20,20],
      value: "place3"
    }
  ]


  let activeMarkers = [];

  function activatePlaceChoiceMarkers(placeOptions = [], callback = v => console.log('User chose:', v)) {
    // remove any existing markers first
    activeMarkers.forEach(m => m.remove());
    activeMarkers = [];

    placeOptions.forEach(opt => {
      const el = document.createElement('img');
      el.src = 'icons/anker-icon.png';
      el.style.width = '4em';
      el.className = 'place-marker';
 
      el.addEventListener('click', () => {
        callback(opt.value);
        // remove all markers after a selection
        activeMarkers.forEach(m => m.remove());
        activeMarkers = [];
      });

      const marker = new maplibregl.Marker({ element: el })
        .setLngLat(opt.location)
        .addTo(map);      
      activeMarkers.push(marker);
    }
    
    );


    for(i=0;i<placeOptions.length;i++) {
      new maplibregl.Marker({element: el})
      .setLngLat([4.9, 52.37])
      .addTo(map);
    }
  }

  hideAllInstruments()
  showInstrument(4)
  activatePlaceChoiceMarkers(examplePlaceOptions)

  function zoomToPlace(lng, lat) {
    map.easeTo({
      center: [lng, lat],
      zoom: 10,
      bearing: 20,   // optional: face direction of travel
      duration: 1000,  // short ease to keep motion smooth
      essential: true
    });
  }

  // Core animation loop
  function animateAlong(lineFeature, marker, { speedKts = 2000000, loop = true, centerCamera = true } = {}) {
    const line = turf.lineString(lineFeature.geometry.coordinates);
    const lengthNm = turf.length(line, { units: 'nauticalmiles' }); // route length in NM
    const totalMs = (lengthNm / speedKts) * 3600 * 1000;            // time to traverse
    let start = performance.now();

    // compute zoom range once
    const zoomStart = map.getZoom();
    const bounds = turf.bbox(line);
    const zoomEnd = map.cameraForBounds([
      [bounds[0], bounds[1]],
      [bounds[2], bounds[3]]
    ]).zoom/1.1;

    map.easeTo({
      center: [(bounds[0] + bounds[2]) / 2, (bounds[1] + bounds[3]) / 2],
      zoom: zoomEnd,
      bearing: 20,   // optional: face direction of travel
      duration: 1000,  // short ease to keep motion smooth
      essential: true
    });

    // prepare a marker instead of a GeoJSON source
    const startCoord = lineFeature.geometry.coordinates[0];

    function frame(now) {
      let elapsed = now - start;
      if (elapsed > totalMs) {
        if (!loop) return;
        // restart cleanly
        start = now;
        elapsed = 0;
      }
      const t = Math.min(elapsed / totalMs, 1);
      const pt = pointAt(lineFeature, t);
      const [lng, lat] = pt.geometry.coordinates;
      
      marker.setLngLat([lng, lat]);

      requestAnimationFrame(frame);
    }
    requestAnimationFrame(frame);
  }
</script>
</body>
</html>
