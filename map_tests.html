<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Tabletop Boats</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet"/>
  <style>
    html,body,#map {
      height:100%;
      margin:0;
      background:#2e1f02;
    }

    .map-area {
      position:relative;
      width:90%;          /* 5% left/right */
      height:95%;         /* 5% top */
      margin:5%;
      top: 5%;
    }

    .map-clip {
      position:absolute;
      inset:0;
      overflow:hidden;    /* crops pitched map edges */
    }

    #map {
      width:100%;
      height:100%;
      position:relative;
      z-index:1;
    }

    .map-border {
      position:absolute;
      z-index:2;                /* above map */
      top: 5%;
      width:100%;
      height:100%;
      pointer-events:none;
      transform: perspective(1000px) rotateX(20deg);   /* same pitch as map */
      transform-origin:center center;
    }

    /* Keep pixel-art crisp when scaled */
    canvas, .maplibregl-canvas { image-rendering: pixelated; }

  </style>
</head>
<body>
<div class="map-area">
  <div class="map-clip">
    <div id="map"></div>
  </div>
</div>
  <img src="images/vintage-paper-texture-1504806601t0F-background.png" class="map-border" alt="">

<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<script type="module">
import * as Strudel from "https://strudel.cc/releases/latest/strudel.mjs";
await Strudel.init();

const music1 = 

</script>

<script type="module">
  // 1) Boot map


  async function loadGeoJSON(url) {
    const response = await fetch(url);
    if (!response.ok) throw new Error('Failed to load GeoJSON');
    return await response.json();
  }

  const geojson_routes = await loadGeoJSON('data/routes.geojson');

  function getRouteFeature(startUrl, endUrl) {
    const feature = geojson_routes.features.find(f =>
      f.properties.dplace === startUrl && f.properties.aplace === endUrl
    );
    return feature ? feature : null;
  }

  const map = new maplibregl.Map({
    container: 'map',
    style: {
      version: 8,

      sources: {
        ne_hr: {
          type: 'raster',
          tiles: [
            'https://www.goudatijdmachine.nl/geoserver/hetzinkendeschip/wms?' +
            'service=WMS&request=GetMap' +
            '&layers=hetzinkendeschip:NE2_HR_LC_SR_W_DR' +
            '&styles=&format=image/jpeg&transparent=false&version=1.1.1' +
            '&width=256&height=256' +
            '&srs=EPSG:3857&bbox={bbox-epsg-3857}'
          ],
          tileSize: 256,
          attribution: 'Natural Earth 2 High Resolution'
        },

        karta_ofver_nede: {
          type: 'raster',
          tiles: [
            'https://www.goudatijdmachine.nl/geoserver/hetzinkendeschip/wms?' +
            'service=WMS&request=GetMap' +
            '&layers=hetzinkendeschip:karta-ofver-nede-2d6ac673a7ff4048' +
            '&styles=&format=image/jpeg&transparent=false&version=1.1.1' +
            '&width=256&height=256' +
            '&srs=EPSG:3857&bbox={bbox-epsg-3857}'
          ],
          tileSize: 256,
          attribution: 'karta_ofver_nede'
        },

        carte_reduite: {
          type: 'raster',
          tiles: [
            'https://www.goudatijdmachine.nl/geoserver/hetzinkendeschip/wms?' +
            'service=WMS&request=GetMap' +
            '&layers=hetzinkendeschip:carte-reduite-de-f09fdf2128df419c' +
            '&styles=&format=image/jpeg&transparent=false&version=1.1.1' +
            '&width=256&height=256' +
            '&srs=EPSG:3857&bbox={bbox-epsg-3857}'
          ],
          tileSize: 256,
          attribution: 'Bellin, Jacques Nicolas, 1703–1772'
        },

        nova_totius_terr: {
          type: 'raster',
          tiles: [
            'https://www.goudatijdmachine.nl/geoserver/hetzinkendeschip/wms?' +
            'service=WMS&request=GetMap' +
            '&layers=hetzinkendeschip:nova-totius-terr-16f53c38a9ae485a' +
            '&styles=&format=image/jpeg&transparent=false&version=1.1.1' +
            '&width=256&height=256' +
            '&srs=EPSG:3857&bbox={bbox-epsg-3857}'
          ],
          tileSize: 256,
          attribution: 'nova_totius_terr'
        },

        osm: {
          type: 'raster',
          tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
          tileSize: 256,
          attribution: '© OpenStreetMap contributors'
        },

        opentopo: {
          type: 'raster',
          tiles: [
            'https://a.tile.opentopomap.org/{z}/{x}/{y}.png',
            'https://b.tile.opentopomap.org/{z}/{x}/{y}.png',
            'https://c.tile.opentopomap.org/{z}/{x}/{y}.png'
          ],
          tileSize: 256,
          attribution: 'Map data © OpenStreetMap contributors, SRTM | Style © OpenTopoMap (CC-BY-SA)'
        },

        carto_light: {
          type: 'raster',
          tiles: [
            'https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
            'https://b.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
            'https://c.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
            'https://d.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png'
          ],
          tileSize: 256,
          attribution: '© OpenStreetMap contributors, © CartoDB'
        }
      },


        layers: [
          //{ id: 'osm', type: 'raster', source: 'osm', layout: { visibility: 'visible' } },
          //{ id: 'opentopo', type: 'raster', source: 'opentopo', layout: { visibility: 'none' } },
          { id: 'ne_hr', type: 'raster', source: 'ne_hr', layout: { visibility: 'none' } },
          { id: 'karta_ofver_nede', type: 'raster', source: 'karta_ofver_nede', layout: { visibility: 'none' } },
          { id: 'nova_totius_terr', type: 'raster', source: 'nova_totius_terr', layout: { visibility: 'none' } },
          { id: 'carte_reduite', type: 'raster', source: 'carte_reduite', layout: { visibility: 'none' } },
          { id: 'carto_light', type: 'raster', source: 'carto_light', layout: { visibility: 'none' } }
        ]
    },
    center: [48.895, 1.372], // Amsterdam
    zoom: 2,
    pitch: 55,     // tabletop look
    bearing: 20,   // slight rotation
    antialias: true
  });

    let baseLayers = [];

    map.on('load', () => {
      // collect all raster layers present at load time
      baseLayers = map.getStyle().layers
        .filter(l => l.type === 'raster')
        .map(l => l.id);

      // ensure only the first is visible
      baseLayers.forEach((id, i) =>
        map.setLayoutProperty(id, 'visibility', i === 0 ? 'visible' : 'none')
      );

      console.log('Base layers detected:', baseLayers);
    });

    let currentBase = 0;

    function toggleBase() {
      if (baseLayers.length === 0) {
        console.log('No base layers!!!');
        return;
      }
      map.setLayoutProperty(baseLayers[currentBase], 'visibility', 'none');
      currentBase = (currentBase + 1) % baseLayers.length;
      map.setLayoutProperty(baseLayers[currentBase], 'visibility', 'visible');
      console.log('Base layer:', baseLayers[currentBase]);
    }

    document.addEventListener('keydown', e => {
      if (e.key.toLowerCase() === 't') toggleBase();
    });


  async function safeAddImage(name, src) {
    try {
      await addImage(name, src);
      console.log(`Loaded image: ${name}`);
    } catch (err) {
      console.error(`Failed to load image "${name}" from "${src}":`, err);
    }
  }

  // 3) After load, add sources and layers
  map.on('load', async () => {
    // Sprites: add your pixel PNGs. 64x64 works well.

    //await safeAddImage('boat', 'icons/ship.png'); // placeholder

    const el = document.createElement('img');
    el.src = 'icons/ship.png';
    el.style.width = '3em';


    const boatMarker = new maplibregl.Marker({element: el})
      .setLngLat([4.9, 52.37])
      .addTo(map);

    document.addEventListener('keydown', e => {
    if (e.key.toLowerCase() === 'a') {
      const route = getRouteFeature(
        'http://data.hetzinkendeschip.nl/id/place/65',
        'http://data.hetzinkendeschip.nl/id/place/9'
      );
      if (!route) {
        console.warn('Route not found');
        return;
      }
      animateAlong(route, boatMarker, {loop: false});
    }
  });

    map.addSource('data', {
      type: 'geojson',
      data: 'data/routes.geojson'
    });

    map.addLayer({
      id: 'lines',
      type: 'line',
      source: 'data',
      paint: {
        'line-color': '#ff0000',
        'line-width': 2
      }
    });


    // Start animation
    // animateAlong(route, { speedKts: 25, loop: true, centerCamera: true });
  });

  // Utilities
  function pointAt(lineFeature, t) {
    const line = turf.lineString(lineFeature.geometry.coordinates);
    const len = turf.length(line, { units: 'kilometers' });
    const pt = turf.along(line, t * len, { units: 'kilometers' });
    // compute heading from small step ahead
    const eps = 0.0005 * len;
    const ptA = pt;
    const ptB = turf.along(line, Math.min(t * len + eps, len), { units: 'kilometers' });
    const bearing = 20 //turf.bearing(ptA, ptB);
    return {
      type: 'Feature',
      properties: { heading: bearing },
      geometry: { type: 'Point', coordinates: pt.geometry.coordinates }
    };
  }

  async function addImage(name, src) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => { 
        map.addImage(name, img, { pixelRatio: 1 }); 
        //img.style.display = 'block';
        //document.body.appendChild(img);
        resolve(img); 
      };
      //img.id = name;
      img.onerror = reject;
      img.src = src;
    });
  }

  // Core animation loop
  function animateAlong(lineFeature, marker, { speedKts = 2000000, loop = true, centerCamera = true } = {}) {
    const line = turf.lineString(lineFeature.geometry.coordinates);
    const lengthNm = turf.length(line, { units: 'nauticalmiles' }); // route length in NM
    const totalMs = (lengthNm / speedKts) * 3600 * 1000;            // time to traverse
    let start = performance.now();

    // compute zoom range once
    const zoomStart = map.getZoom();
    const bounds = turf.bbox(line);
    const zoomEnd = map.cameraForBounds([
      [bounds[0], bounds[1]],
      [bounds[2], bounds[3]]
    ]).zoom/1.1;

    map.easeTo({
      center: [(bounds[0] + bounds[2]) / 2, (bounds[1] + bounds[3]) / 2],
      zoom: zoomEnd,
      bearing: 20,   // optional: face direction of travel
      duration: 1000,  // short ease to keep motion smooth
      essential: true
    });


    // prepare a marker instead of a GeoJSON source
    const startCoord = lineFeature.geometry.coordinates[0];

    function frame(now) {
      let elapsed = now - start;
      if (elapsed > totalMs) {
        if (!loop) return;
        // restart cleanly
        start = now;
        elapsed = 0;
      }
      const t = Math.min(elapsed / totalMs, 1);
      const pt = pointAt(lineFeature, t);
      const [lng, lat] = pt.geometry.coordinates;
      
      marker.setLngLat([lng, lat]);

      requestAnimationFrame(frame);
    }
    requestAnimationFrame(frame);
  }
</script>
</body>
</html>
